generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Status {
  ATIVO
  INATIVO
  BLOQUEADO
}

model Subscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  Usuarios  Usuarios @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  endpoint  String   @db.Text
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum StatusFatura {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
}

model FaturasContas {
  id             Int          @id @default(autoincrement())
  contaId        Int
  conta          Contas       @relation(fields: [contaId], references: [id])
  Uid            String       @default("INV_000")
  asaasPaymentId String       @unique
  vencimento     DateTime
  valor          Float
  urlPagamento   String
  status         StatusFatura @default(PENDENTE)
  criadoEm       DateTime     @default(now())
}

enum GatewayConta {
  mercadopago
  asaass
}

model Contas {
  id                       Int                    @id @default(autoincrement())
  nome                     String
  valor                    Decimal                @db.Decimal(10, 2)
  data                     DateTime
  profile                  String?                @default("imgs/logo.png")
  status                   Status                 @default(ATIVO)
  vencimento               DateTime               @default(now())
  tipo                     String?
  documento                String?
  ie                       String?
  im                       String?
  regimeTributario         Int                    @default(0)
  regimeTributarioEspecial Int                    @default(0)
  ambiente                 String                 @default("homologacao")
  certificadoPath          String?
  chaveAcesso              String?
  funcionarios             Int                    @default(0)
  categoria                String?
  gateway                  GatewayConta           @default(mercadopago)
  email                    String
  telefone                 String?
  endereco                 String?
  nomeFantasia             String?
  cep                      String?
  emailAvisos              String?
  asaasCustomerId          String
  asaasSubscriptionId      String?
  dicasNovidades           Boolean?               @default(false)
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  Produto                  Produto[]
  Clientes                 ClientesFornecedores[]
  Vendas                   Vendas[]
  MovimentacoesEstoque     MovimentacoesEstoque[]
  Usuarios                 Usuarios[]
  FaturasContas            FaturasContas[]
  ContasFinanceiro         ContasFinanceiro[]
  CategoriaFinanceiro      CategoriaFinanceiro[]
  LancamentoFinanceiro     LancamentoFinanceiro[]
  Servicos                 Servicos[]
  OrdensServico            OrdensServico[]
  ParametrosConta          ParametrosConta[]
  CobrancasFinanceiras     CobrancasFinanceiras[]
  assinaturas              Assinatura[]
  notaFiscals              NotaFiscal[]
  arenaQuadras             ArenaQuadras[]
}

model ParametrosConta {
  id                             Int      @id @default(autoincrement())
  contaId                        Int      @unique
  Contas                         Contas   @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  MercadoPagoApiKey              String?
  AsaasApiKey                    String?
  AsaasApiSecret                 String?
  MercadoPagoEnv                 String?
  AsaasEnv                       String?
  emailAvisos                    String?
  eventoVendaConcluida           Boolean? @default(true)
  eventoSangria                  Boolean? @default(false)
  eventoEstoqueBaixo             Boolean? @default(true)
  linkPublicoAtivo               Boolean? @default(false)
  cadastrosPermitidosLinkPublico Int?     @default(1)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt
}

model Usuarios {
  id                              Int                               @id @default(autoincrement())
  contaId                         Int
  Contas                          Contas                            @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  nome                            String
  email                           String                            @unique
  senha                           String
  superAdmin                      Boolean                           @default(false)
  gerencialMode                   Boolean                           @default(false)
  permissao                       PermissaoUsuario                  @default(usuario)
  pushReceiver                    Boolean?                          @default(true)
  emailReceiver                   Boolean?                          @default(true)
  telefone                        String?
  profile                         String?
  biografia                       String?                           @db.Text
  endereco                        String?
  status                          Status                            @default(ATIVO)
  createdAt                       DateTime                          @default(now())
  updatedAt                       DateTime                          @updatedAt
  Subscription                    Subscription[]
  Vendas                          Vendas[]
  MensagensInteracoesOrdemServico MensagensInteracoesOrdemServico[]
  OrdensServico                   OrdensServico[]
}

enum PermissaoUsuario {
  root
  admin
  gerente
  vendedor
  tecnico
  usuario
}

enum TipoCliente {
  FORNECEDOR
  CLIENTE
}

model ClientesFornecedores {
  id                   Int                    @id @default(autoincrement())
  contaId              Int
  Contas               Contas                 @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                  String                 @default("CLI_000")
  status               Status                 @default(ATIVO)
  documento            String?
  endereco             String?
  ie                   String?
  im                   String?
  municipio            String?
  bairro               String?
  numero               String?
  cep                  String?
  cidade               String?
  estado               String?
  nome                 String
  email                String?
  telefone             String?
  whastapp             String?
  observacaos          String?
  tipo                 TipoCliente            @default(CLIENTE)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  Vendas               Vendas[]
  MovimentacoesEstoque MovimentacoesEstoque[]
  LancamentoFinanceiro LancamentoFinanceiro[]
  Assinatura           Assinatura[]
  NotaFiscal           NotaFiscal[]
  OrdensServico        OrdensServico[]
  arenaAgendamentos    ArenaAgendamentos[]
}

enum TipoMovimentacao {
  ENTRADA
  SAIDA
  DESCARTE
  TRANSFERENCIA
}

enum StatusMovimentacao {
  PENDENTE
  CONCLUIDO
  CANCELADO
}

model MovimentacoesEstoque {
  id                Int                   @id @default(autoincrement())
  contaId           Int
  Contas            Contas                @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid               String                @default("MOV_000")
  tipo              TipoMovimentacao      @default(ENTRADA)
  vendaId           Int?
  Vendas            Vendas?               @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  ordemId           Int?
  OrdensServico     OrdensServico?        @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  data              DateTime              @default(now())
  notaFiscal        String?
  frete             Decimal?              @db.Decimal(10, 2)
  desconto          Decimal?              @db.Decimal(10, 2)
  status            StatusMovimentacao    @default(PENDENTE)
  clienteFornecedor Int?
  ClienteFornecedor ClientesFornecedores? @relation(fields: [clienteFornecedor], references: [id])
  produtoId         Int
  Produto           Produto               @relation(fields: [produtoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  quantidade        Int
  custo             Decimal               @db.Decimal(10, 2)
}

model Produto {
  id                   Int                    @id @default(autoincrement())
  contaId              Int
  Contas               Contas                 @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                  String                 @default("PRO_000")
  status               Status                 @default(ATIVO)
  categoria            String?
  nome                 String
  descricao            String?
  preco                Decimal                @db.Decimal(10, 2)
  precoCompra          Decimal?               @db.Decimal(10, 2)
  entradas             Boolean?               @default(true)
  saidas               Boolean?               @default(true)
  unidade              String?
  estoque              Int
  minimo               Int
  codigo               String?
  ncm                  String?
  cest                 String?
  cfop                 String?
  origem               Int?
  aliquotaIcms         Decimal?               @db.Decimal(5, 2)
  aliquotaIpi          Decimal?               @db.Decimal(5, 2)
  aliquotaPis          Decimal?               @db.Decimal(5, 2)
  aliquotaCofins       Decimal?               @db.Decimal(5, 2)
  codigoProduto        String?
  issAliquota          Decimal?               @db.Decimal(5, 2)
  controlaEstoque      Boolean?               @default(false)
  producaoLocal        Boolean?               @default(false)
  custoMedioProducao   Decimal?               @db.Decimal(10, 2)
  ItensVendas          ItensVendas[]
  MovimentacoesEstoque MovimentacoesEstoque[]
  ItensOrdensServico   ItensOrdensServico[]
}

model Servicos {
  id                 Int                  @id @default(autoincrement())
  contaId            Int
  Contas             Contas               @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                String               @default("SER_000")
  nome               String
  preco              Decimal              @db.Decimal(10, 2)
  status             Boolean              @default(true)
  descricao          String?
  ncm                String?
  cest               String?
  cfop               String?
  origem             Int?
  aliquotaIcms       Decimal?             @db.Decimal(5, 2)
  aliquotaIpi        Decimal?             @db.Decimal(5, 2)
  aliquotaPis        Decimal?             @db.Decimal(5, 2)
  aliquotaCofins     Decimal?             @db.Decimal(5, 2)
  codigoProduto      String?
  issAliquota        Decimal?             @db.Decimal(5, 2)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  Assinatura         Assinatura[]
  ItensOrdensServico ItensOrdensServico[]
}

model NotaFiscal {
  id          Int                  @id @default(autoincrement())
  contaId     Int
  Conta       Contas               @relation(fields: [contaId], references: [id])
  tipo        String // "NFE", "NFSE", "NFCE"
  clienteId   Int
  Cliente     ClientesFornecedores @relation(fields: [clienteId], references: [id])
  valorTotal  Decimal              @db.Decimal(10, 2)
  chaveAcesso String? // retornado pela TecnoSpeed
  protocolo   String? // retornado pela TecnoSpeed
  status      String // "PENDENTE", "AUTORIZADA", "REJEITADA"
  xmlPath     String?
  criadoEm    DateTime             @default(now())
}

enum StatusOrdemServico {
  ABERTA
  ORCAMENTO
  APROVADA
  ANDAMENTO
  FATURADA
  CANCELADA
}

model OrdensServico {
  id                              Int                               @id @default(autoincrement())
  contaId                         Int
  Contas                          Contas                            @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                             String                            @default("OS_000")
  descricao                       String?
  descricaoCliente                String?
  status                          StatusOrdemServico                @default(ABERTA)
  garantia                        String
  clienteId                       Int
  Cliente                         ClientesFornecedores              @relation(fields: [clienteId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  operadorId                      Int
  Operador                        Usuarios                          @relation(fields: [operadorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  desconto                        Decimal                           @default(0) @db.Decimal(10, 2)
  data                            DateTime                          @default(now())
  createdAt                       DateTime                          @default(now())
  updatedAt                       DateTime                          @updatedAt
  ItensOrdensServico              ItensOrdensServico[]
  CobrancasFinanceiras            CobrancasFinanceiras[]
  MensagensInteracoesOrdemServico MensagensInteracoesOrdemServico[]
  MovimentacoesEstoque            MovimentacoesEstoque[]
}

enum TipoMensagemOrdemServico {
  ABERTURA
  MENSAGEM
  ENCERRAMENTO
}

model MensagensInteracoesOrdemServico {
  id        Int                      @id @default(autoincrement())
  ordemId   Int
  ordem     OrdensServico            @relation(fields: [ordemId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  mensagem  String
  tipo      TipoMensagemOrdemServico @default(ABERTURA)
  autorId   Int?
  Autor     Usuarios?                @relation(fields: [autorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  data      DateTime                 @default(now())
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
}

enum TipoItemOrdemServico {
  SERVICO
  PRODUTO
}

model ItensOrdensServico {
  id         Int                  @id @default(autoincrement())
  itemName   String
  tipo       TipoItemOrdemServico
  ordemId    Int
  ordem      OrdensServico        @relation(fields: [ordemId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  produtoId  Int?
  produto    Produto?             @relation(fields: [produtoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  servicoId  Int?
  servico    Servicos?            @relation(fields: [servicoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  quantidade Int
  valor      Decimal              @db.Decimal(10, 2)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
}

enum AssinaturaInternaStatus {
  ATIVA
  CANCELADA
  SUSPENSA
}

enum AssinaturaInternaRecorrencia {
  MENSAL
  BIMESTRAL
  TRIMESTRAL
  ANUAL
}

model Assinatura {
  id              Int                          @id @default(autoincrement())
  contaId         Int
  Conta           Contas                       @relation(fields: [contaId], references: [id])
  clienteId       Int
  servicoId       Int
  inicio          DateTime
  fim             DateTime?
  status          AssinaturaInternaStatus      @default(ATIVA)
  recorrencia     AssinaturaInternaRecorrencia @default(MENSAL)
  proximaCobranca DateTime
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt
  cliente         ClientesFornecedores         @relation(fields: [clienteId], references: [id])
  servico         Servicos                     @relation(fields: [servicoId], references: [id])
  cobrancas       Cobranca[]
}

model Cobranca {
  id            Int        @id @default(autoincrement())
  assinaturaId  Int
  vencimento    DateTime
  pago          Boolean    @default(false)
  valor         Decimal    @db.Decimal(10, 2)
  dataPagamento DateTime?
  assinatura    Assinatura @relation(fields: [assinaturaId], references: [id])
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

enum StatusVenda {
  ORCAMENTO
  FATURADO
  ANDAMENTO
  FINALIZADO
  PENDENTE
  CANCELADO
}

model Vendas {
  id                   Int                    @id @default(autoincrement())
  contaId              Int
  Contas               Contas                 @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                  String                 @default("VEN_000")
  data                 DateTime               @default(now())
  valor                Decimal                @db.Decimal(10, 2)
  clienteId            Int?
  status               StatusVenda            @default(ORCAMENTO)
  cliente              ClientesFornecedores?  @relation(fields: [clienteId], references: [id])
  vendedorId           Int?
  vendedor             Usuarios?              @relation(fields: [vendedorId], references: [id])
  garantia             Int?                   @default(0)
  faturado             Boolean                @default(false)
  observacoes          String?                @db.Text
  desconto             Decimal                @default(0) @db.Decimal(10, 2)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  ItensVendas          ItensVendas[]
  PagamentoVendas      PagamentoVendas?
  MovimentacoesEstoque MovimentacoesEstoque[]
  LancamentoFinanceiro LancamentoFinanceiro[]
  CobrancasFinanceiras CobrancasFinanceiras[]
}

model ItensVendas {
  id         Int      @id @default(autoincrement())
  vendaId    Int
  venda      Vendas   @relation(fields: [vendaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  produtoId  Int
  produto    Produto  @relation(fields: [produtoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  quantidade Int
  valor      Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum StatusPagamento {
  PENDENTE
  EFETIVADO
  ESTORNADO
  CANCELADO
}

enum MetodoPagamento {
  PIX
  DINHEIRO
  CARTAO
  BOLETO
  TRANSFERENCIA
  CHEQUE
  CREDITO
  DEBITO
  GATEWAY
  OUTRO
}

model PagamentoVendas {
  id      Int             @id @default(autoincrement())
  venda   Vendas          @relation(fields: [vendaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  vendaId Int             @unique
  metodo  MetodoPagamento @default(PIX)
  valor   Decimal         @db.Decimal(10, 2)
  data    DateTime?
  status  StatusPagamento @default(PENDENTE)
}

model ContasFinanceiro {
  id                Int                    @id @default(autoincrement())
  contaId           Int
  Contas            Contas                 @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid               String                 @default("CON_000")
  nome              String
  saldoInicial      Decimal                @default(0)
  lancamentos       LancamentoFinanceiro[]
  createdAt         DateTime               @default(now())
  ParcelaFinanceiro ParcelaFinanceiro[]
}

model CategoriaFinanceiro {
  id                  Int                    @id @default(autoincrement())
  contaId             Int
  Contas              Contas                 @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                 String                 @default("CAT_000")
  nome                String
  parentId            Int?
  Parent              CategoriaFinanceiro?   @relation("Subcategorias", fields: [parentId], references: [id])
  lancamentos         LancamentoFinanceiro[]
  createdAt           DateTime               @default(now())
  CategoriaFinanceiro CategoriaFinanceiro[]  @relation("Subcategorias")
}

model CobrancasFinanceiras {
  id                Int                @id @default(autoincrement())
  contaId           Int
  Contas            Contas             @relation(fields: [contaId], references: [id], onDelete: Cascade)
  idCobranca        String             @default("COB_000")
  Uid               String             @default("COB_000")
  externalLink      String?            @db.Text
  valor             Decimal
  gateway           String
  dataVencimento    DateTime
  dataCadastro      DateTime           @default(now())
  status            StatusPagamento    @default(PENDENTE)
  observacao        String?
  lancamentoId      Int?
  LancamentoParcela ParcelaFinanceiro? @relation(fields: [lancamentoId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  vendaId           Int?
  Venda             Vendas?            @relation(fields: [vendaId], references: [id], onDelete: Restrict)
  ordemServicoId    Int?
  Ordemservico      OrdensServico?     @relation(fields: [ordemServicoId], references: [id])
}

model LancamentoFinanceiro {
  id                 Int                       @id @default(autoincrement())
  contaId            Int
  Contas             Contas                    @relation(fields: [contaId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  Uid                String                    @default("FIN_000")
  descricao          String
  valorTotal         Decimal                   @default(0) // total com desconto inclu√≠do
  valorBruto         Decimal                   @default(0)
  valorEntrada       Decimal                   @default(0)
  desconto           Decimal                   @default(0)
  tipo               TipoLancamentoFinanceiro
  formaPagamento     MetodoPagamento
  status             StatusPagamentoFinanceiro
  recorrente         Boolean                   @default(false)
  dataLancamento     DateTime
  dataEntrada        DateTime?
  clienteId          Int?
  cliente            ClientesFornecedores?     @relation(fields: [clienteId], references: [id])
  categoriaId        Int
  categoria          CategoriaFinanceiro       @relation(fields: [categoriaId], references: [id])
  vendaId            Int?
  venda              Vendas?                   @relation(fields: [vendaId], references: [id], onDelete: Restrict)
  parcelas           ParcelaFinanceiro[]
  createdAt          DateTime                  @default(now())
  ContasFinanceiro   ContasFinanceiro?         @relation(fields: [contasFinanceiroId], references: [id])
  contasFinanceiroId Int?
}

model ParcelaFinanceiro {
  id                   Int                    @id @default(autoincrement())
  descricao            String?
  contaFinanceira      Int?
  ContaFinanceira      ContasFinanceiro?      @relation(fields: [contaFinanceira], references: [id], onDelete: Restrict, onUpdate: Cascade)
  numero               Int
  Uid                  String                 @default("PAR_000")
  valor                Decimal
  vencimento           DateTime
  pago                 Boolean                @default(false)
  valorPago            Decimal?
  formaPagamento       MetodoPagamento?
  dataPagamento        DateTime?
  lancamentoId         Int
  lancamento           LancamentoFinanceiro   @relation(fields: [lancamentoId], references: [id], onDelete: Cascade)
  CobrancasFinanceiras CobrancasFinanceiras[]

  @@index([lancamentoId, id])
}

enum TipoLancamentoFinanceiro {
  RECEITA
  DESPESA
}

enum StatusPagamentoFinanceiro {
  PENDENTE
  PAGO
  ATRASADO
  PARCIAL
}

model ArenaQuadras {
  id                    Int                 @id @default(autoincrement())
  contaId               Int
  Conta                 Contas              @relation(fields: [contaId], references: [id])
  tempoMinimo           Int                 @default(60)
  tempoReserva          Int                 @default(60)
  name                  String
  description           String?
  precoHora             Decimal             @default(0)
  permitirReservaOnline Boolean             @default(true)
  aprovarSemPagamento   Boolean             @default(false)
  active                Boolean             @default(true)
  schedules             ArenaAgendamentos[]
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

model ArenaAgendamentos {
  id              Int                    @id @default(autoincrement())
  quadraId        Int
  clienteId       Int?
  nomeCliente     String?
  enderecoCliente String?
  telefoneCliente String?
  startAt         DateTime
  endAt           DateTime
  status          ArenaAgendamentoStatus @default(PENDENTE)
  valor           Decimal                @default(0)
  recorrente      Boolean                @default(false)
  observacoes     String?                @db.Text

  Quadra  ArenaQuadras          @relation(fields: [quadraId], references: [id])
  Cliente ClientesFornecedores? @relation(fields: [clienteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([quadraId, startAt, endAt])
  @@index([quadraId, startAt, endAt])
}

enum ArenaAgendamentoStatus {
  PENDENTE
  CONFIRMADA
  FINALIZADA
  CANCELADA
  BLOQUEADO
}
