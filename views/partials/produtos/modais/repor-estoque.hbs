<div id="modalOverlayReposicaoEstoqueProduto"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300">
    <div id="sheetContainerReposicaoEstoqueProduto"
        class="bg-gray-100 dark:bg-background-dark w-full max-w-md mx-auto rounded-lg shadow-xl transform scale-95 opacity-0 transition-all duration-300 ease-in-out overflow-hidden">
        <div
            class="bg-inherit border-b border-border dark:border-border-dark px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold"><i class="fa-solid fa-box-open text-emerald-600"></i> Repor Estoque
            </h2>
            <button onclick="fecharModalReporProdutos()"
                class="text-gray-800 dark:text-white hover:text-gray-400 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="formularioProdutosreposicao">
            <input type="hidden" name="id" id="id" />
            <div class="grid gap-4 mb-4 sm:grid-cols-2 p-4">
                <div class="sm:col-span-2">
                    <label for="produto_reposicao_modal"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Produto <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="produto" id="produto_reposicao_modal" required
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Nome do produto" />
                </div>
                <div>
                    <label for="quantidadeReposicaoEstoque"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Quantidade <span
                            class="text-red-500">*</span></label>
                    <input type="number" name="quantidade" id="quantidadeReposicaoEstoque" required min="1"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Ex. 10" />
                </div>
                <div>
                    <label for="custoReposicaoEstoque"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Valor unitário (Compra)
                        <span class="text-red-500">*</span></label>
                    <input type="text" name="custo" id="custoReposicaoEstoque" required
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Ex. 99,90" />
                </div>
                <div>
                    <label for="descontoCompraProduto"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Desconto</label>
                    <input type="text" name="quantidade" id="descontoCompraProduto"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Ex. 10,90" />
                </div>
                <div>
                    <label for="freteCompraMercadoria"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Frete</label>
                    <input type="text" name="custo" id="freteCompraMercadoria"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Ex. 5,90" />
                </div>
                <div>
                    <label for="notaFiscalCompraProduto"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nota Fiscal</label>
                    <input type="number" name="quantidade" id="notaFiscalCompraProduto"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Ex. 000111222" />
                </div>
                <div>
                    <label for="fornecedorMercadoria"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fornecedor</label>
                    <input type="text" name="custo" id="fornecedorMercadoria"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Nome do fornecedor" />
                </div>
            </div>

            <div class="px-6 py-4 bg-inherit border-t border-border dark:border-border-dark">
                <div class="flex gap-3">
                    <button type="submit"
                        class="w-full px-4 py-2 cursor-pointer flex justify-center items-center gap-2 text-sm font-medium border-2 border-emerald-500 hover:border-emerald-700 text-emerald-900 dark:text-emerald-200 bg-emerald-500/20 rounded-md shadow transition">
                        <i class="fa-solid fa-circle-check"></i>
                        Registrar
                    </button>
                    <button type="button" onclick="fecharModalReporProdutos()"
                        class="w-full px-4 py-2 text-sm font-medium text-gray-800 dark:border-gray-500 dark:text-white bg-gray-300 dark:bg-gray-800 rounded-md transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    MaskToInputMoney(document.getElementById('custoReposicaoEstoque'));
    MaskToInputMoney(document.getElementById('descontoCompraProduto'));
    MaskToInputMoney(document.getElementById('freteCompraMercadoria'));
    function openModalReposicaoEstoqueOnly() {
        const overlay = document.getElementById('modalOverlayReposicaoEstoqueProduto');
        const modal = document.getElementById('sheetContainerReposicaoEstoqueProduto');

        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Força reflow
        void modal.offsetWidth;

        modal.classList.remove('opacity-0', 'scale-95');
        modal.classList.add('opacity-100', 'scale-100');
    }

    $("#formularioProdutosreposicao").submit(function (e) {
        e.preventDefault();
        const data = {
            produtoId: $("#formularioProdutosreposicao #id").val(),
            quantidade: $("#formularioProdutosreposicao #quantidadeReposicaoEstoque").val(),
            custo: $("#formularioProdutosreposicao #custoReposicaoEstoque").val(),
            desconto: $("#formularioProdutosreposicao #descontoCompraProduto").val(),
            frete: $("#formularioProdutosreposicao #freteCompraMercadoria").val(),
            notaFiscal: $("#formularioProdutosreposicao #notaFiscalCompraProduto").val(),
            fornecedor: $("#formularioProdutosreposicao #fornecedorMercadoria").val(),
        };

        $.ajax({
            url: `/api/produtos/reposicao`,
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('gestao_facil:token')}`
            },
            method: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify(data),
            beforeSend: function (xhr) {
                Swal.fire({
                    title: 'Carregando...',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            },
            success: function (data) {
                Swal.fire({
                    title: 'Sucesso!',
                    text: 'Estoque do produto atualizado!',
                    icon: 'success',
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 3000,
                });
                if (typeof reloadTabelaProdutos === "function") {
                    reloadTabelaProdutos();
                }
                if (typeof getProdutosListagem === "function") {
                    getProdutosListagem();
                }
                fecharModalReporProdutos();
            },
            error: function (xhr, status, error) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Erro!',
                    text: xhr.responseJSON?.message || 'Erro inesperado na requisição',
                    confirmButtonText: 'Ok'
                });
            }
        })
    });

    function abrirModalReporProdutos(id) {
        if (id) {
            $.ajax({
                url: `/api/produtos/${id}`,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('gestao_facil:token')}`
                },
                method: 'GET',
                dataType: 'json',
                beforeSend: function (xhr) {
                    Swal.fire({
                        title: 'Carregando...',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                },
                success: function ({ data }) {
                    Swal.close();
                    $("#formularioProdutosreposicao #produto_reposicao_modal").val(data.nome).prop("disabled", true);
                    $("#formularioProdutosreposicao #id").val(data.id);
                    openModalReposicaoEstoqueOnly();
                },
                error: function (error) {
                    console.log(error);
                    showNotification("Erro inesperado na requisição", 'error');
                }
            })
        }
    }

    function fecharModalReporProdutos() {
        const overlay = document.getElementById('modalOverlayReposicaoEstoqueProduto');
        const modal = document.getElementById('sheetContainerReposicaoEstoqueProduto');

        modal.classList.remove('opacity-100', 'scale-100');
        modal.classList.add('opacity-0', 'scale-95');

        setTimeout(() => {
            overlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }, 300);
    }

    // Fechamento por ESC e clique fora
    document.addEventListener('keydown', e => e.key === 'Escape' && fecharModalReporProdutos());

    $("#modalFormularioContasFinanceiras").submit(function (e) {
        e.preventDefault();

        $.ajax({
            url: '/api/lancamentos/contas',
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('gestao_facil:token')}`
            },
            success: function (data) {
                fecharModalReporProdutos();
                showNotification(data.message, 'success');
                const formulario = document.getElementById('modalFormularioContasFinanceiras');
                formulario.reset();
                if (typeof reloadTabelaContasFinanceiras === "function") {
                    reloadTabelaContasFinanceiras();
                }
                if (typeof renderListaContasFinanceiras === "function") {
                    renderListaContasFinanceiras();
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                showNotification(xhr.responseJSON?.message || 'Erro inesperado na requisição', 'error');
            }
        });
    });
</script>