<div class="h-full flex flex-col justify-center">
  <h2 class="text-2xl font-bold text-primary dark:text-primary-dark mb-6" id="produtoFormularioTitulo">
    ðŸ“¦ Novo Produto
  </h2>
  <div
    class="border bg-background dark:bg-background-dark border-border dark:border-border-dark p-6 rounded-2xl shadow-md w-full h-full">

    <form id="formularioProdutos" class="space-y-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Nome -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1" for="nome">Produto <span class="text-red-500">*</span></label>
        <input type="text" name="nome" id="nome" required placeholder="Nome do produto"
          class="w-full p-2 rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark" />
      </div>
      <!-- CÃ³digo -->
      <div>
        <label class="block text-sm font-medium mb-1" for="codigo">CÃ³digo</label>
        <input type="text" name="codigo" id="codigo" placeholder="CÃ³digo do produto"
          class="w-full p-2 rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark" />
      </div>


      <!-- PreÃ§o -->
      <div>
        <label class="block text-sm font-medium mb-1" for="preco">PreÃ§o <span class="text-red-500">*</span></label>
        <input type="text" name="preco" id="preco" required
          class="w-full p-2 money_mask rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark"
          placeholder="Ex: 99,90" />
      </div>

      <!-- Estoque Inicial -->
      <div>
        <label class="block text-sm font-medium mb-1" for="estoque">Estoque Inicial <span
            class="text-red-500">*</span></label>
        <input type="number" name="estoque" id="estoque" placeholder="Ex: 100" required
          class="w-full p-2 rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark" />
      </div>

      <!-- Estoque MÃ­nimo -->
      <div>
        <label class="block text-sm font-medium mb-1" for="minimo">Estoque MÃ­nimo <span
            class="text-red-500">*</span></label>
        <input type="number" name="minimo" id="minimo" placeholder="Ex: 10" required
          class="w-full p-2 rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark" />
      </div>

      <!-- ObservaÃ§Ã£o -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1" for="descricao">ObservaÃ§Ã£o</label>
        <textarea name="descricao" id="descricao" rows="4" placeholder="Adicione observaÃ§Ãµes sobre o produto"
          class="w-full p-2 rounded-md border bg-card dark:bg-card-dark border-border dark:border-border-dark"></textarea>
      </div>

      <input type="hidden" name="id" id="id" />

      <!-- BotÃµes -->
      <div class="flex gap-2 justify-end md:col-span-2">
        <button type="button" onclick="loadPage('partials/produtos/index.html')"
          class="bg-secondary text-sm hover:opacity-90 text-white px-3 py-1.5 rounded-md">
          <i class="fa-solid fa-backward"></i> Voltar
        </button>
        <button type="submit"
          class="bg-primary text-sm dark:bg-primary-dark hover:opacity-90 text-white px-3 py-1.5 rounded-md">
          <i class="fa-solid fa-floppy-disk"></i> Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  IMask(document.getElementById('preco'), {
    mask: Number,
    scale: 2,
    signed: false,
    thousandsSeparator: '',
    padFractionalZeros: true,
    normalizeZeros: true,
    radix: ',', // separador decimal brasileiro
    mapToRadix: ['.']
  });
  $("#formularioProdutos").off('submit').on('submit', function (e) {
    e.preventDefault();
    const data = {
      codigo: $("#codigo").val(),
      nome: $("#nome").val(),
      preco: $("#preco").val(),
      estoque: $("#estoque").val(),
      minimo: $("#minimo").val(),
      descricao: $("#descricao").val(),
      id: $("#id").val(),
    }
    $.ajax({
      url: `/produtos`,
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('gestao_facil:token')}`
      },
      method: "POST",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify(data),
      beforeSend: function (xhr) {
        Swal.fire({
          title: 'Carregando...',
          allowOutsideClick: false,
          allowEscapeKey: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      },
      success: function (data) {
        Swal.fire({
          title: 'Sucesso!',
          text: 'Produto salvo com sucesso!',
          icon: 'success',
          toast: true,
          position: 'bottom-end',
          showConfirmButton: false,
          timer: 3000,
        });
        htmx.ajax("GET", "partials/produtos/index.html", {
          target: "#content",
          swap: "innerHTML",
        });
      },
      error: function (xhr, status, error) {
        Swal.fire({
          icon: 'error',
          title: 'Erro!',
          text: xhr.responseJSON?.message || 'Erro inesperado na requisiÃ§Ã£o',
          confirmButtonText: 'Ok'
        });
      }
    })
  });

  (() => {
    $('#unidade').select2();
    if (localStorage.getItem('produtoId')) {
      $("#produtoFormularioTitulo").text(`ðŸ“ Editar Produto #${localStorage.getItem('produtoId')}`);
      $("#estoque").prop("readonly", true);
      $.ajax({
        url: `/produtos/${localStorage.getItem('produtoId')}`,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('gestao_facil:token')}`
        },
        method: 'GET',
        dataType: 'json',
        beforeSend: function (xhr) {
          Swal.fire({
            title: 'Carregando...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
        },
        success: function ({ data }) {
          Swal.close();
          $("#id").val(data.id);
          $("#codigo").val(data.codigo);
          $("#nome").val(data.nome);
          $("#preco").val(data.preco);
          $("#estoque").val(data.estoque);
          $("#minimo").val(data.minimo);
          $("#descricao").val(data.descricao);
        },
        error: function (error) {
          console.log(error);
          Swal.fire({
            icon: 'error',
            title: 'Erro ao carregar produto',
            text: 'Ocorreu um erro ao carregar o produto. Por favor, tente novamente mais tarde.',
          });
          htmx.ajax("GET", "partials/produtos/index.html", {
            target: "#content",
            swap: "innerHTML",
          });
        }
      })
    } else {
      $("#produtoFormularioTitulo").text("ðŸ“¦ Novo Produto");
    }
  })();
</script>